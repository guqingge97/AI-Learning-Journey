# M2-W5-D1

## Phase: Month 2 - LLM API å·¥ç¨‹åŒ– | Week 5 - LLMClient åŸºç¡€å°è£…

**ä»Šæ—¥æ ¸å¿ƒç›®æ ‡**ï¼šè®¾è®¡å¯æ›¿æ¢çš„ LLM è°ƒç”¨å±‚éª¨æ¶ï¼ˆæ¥å£ + æ•°æ®ç»“æ„ + Provider æŠ½è±¡ï¼‰

------

### Whyï¼šä¸å­¦ä¼šå¯¼è‡´çš„å·¥ç¨‹æ­»ç©´

ç›´æ¥åœ¨ä¸šåŠ¡ä»£ç é‡Œå†™ `openai.ChatCompletion.create(...)` ä¼šæ€æ ·ï¼Ÿ

- æ¢æ¨¡å‹ä¾›åº”å•†ï¼ˆOpenAI â†’ DeepSeek â†’ æœ¬åœ° Ollamaï¼‰è¦**æ”¹æ‰€æœ‰è°ƒç”¨ç‚¹**
- æµ‹è¯•æ—¶å¿…é¡»çœŸå®è°ƒ APIï¼Œæ¯è·‘ä¸€æ¬¡æµ‹è¯•å°±çƒ§é’±
- è¾“å…¥è¾“å‡ºæ ¼å¼æ•£è½å„å¤„ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ•°æ®ç»“æ„ï¼Œåç»­åŠ æ—¥å¿—/é‡è¯•/ç¼“å­˜æ— å¤„ä¸‹æ‰‹

Java åç«¯ç»éªŒå¯¹ç…§ï¼šä½ é¡¹ç›®é‡Œå°è£…äº† HttpGetClient/HttpPostClientï¼ŒService æ³¨å…¥ Client è€Œä¸æ˜¯ç›´æ¥ newâ€”â€”LLMClient + Provider æ˜¯å®Œå…¨ç›¸åŒçš„æ€è·¯ã€‚

------

### Whatï¼šç¬¬ä¸€æ€§åŸç†

**æ ¸å¿ƒå…¬å¼**ï¼š

> LLMClientï¼ˆè°ƒç”¨å…¥å£ï¼‰= Provider æŠ½è±¡ï¼ˆè°æ¥åšï¼‰+ æ•°æ®ç»“æ„ï¼ˆè¾“å…¥è¾“å‡ºé•¿ä»€ä¹ˆæ ·ï¼‰

ä¸‰ä¸ªè§’è‰²çš„å…³ç³»ï¼š

- **ChatRequest / ChatResponse**ï¼šå®šä¹‰"æ•°æ®é•¿ä»€ä¹ˆæ ·"
- **LLMProviderï¼ˆProtocolï¼‰**ï¼šå®šä¹‰"èƒ½åšä»€ä¹ˆ"â€”â€”æœ‰ chat æ–¹æ³•å°±è¡Œ
- **LLMClient**ï¼šå®šä¹‰"æ€ä¹ˆç”¨"â€”â€”æŒæœ‰ Provider å¼•ç”¨ï¼Œè°ƒç”¨ chat

ç±»æ¯”ï¼šé¤å…æ¨¡å‹

- ChatRequest = ç‚¹èœå•ï¼ˆèœåã€å£å‘³è¦æ±‚ï¼‰
- ChatResponse = ä¸Šçš„èœï¼ˆèœæœ¬èº« + å°ç¥¨ä»·æ ¼ï¼‰
- LLMProvider = å¨å¸ˆæ¥å£ï¼ˆèƒ½åšèœå°±è¡Œï¼Œä¸ç®¡æ˜¯ä¸­é¤å¨å¸ˆè¿˜æ˜¯è¥¿é¤å¨å¸ˆï¼‰
- LLMClient = æœåŠ¡å‘˜ï¼ˆæ¥å• â†’ é€’ç»™å¨å¸ˆ â†’ æŠŠèœç«¯å›æ¥ï¼‰

------

### Howï¼šæœ€å°å¯è¿è¡ŒèŒƒå¼

**é¡¹ç›®ç»“æ„ï¼š**

```
llm-client/
  src/llm_client/
    models.py          â† æ•°æ®ç»“æ„
    provider.py         â† æŠ½è±¡æ¥å£
    mock_provider.py    â† æµ‹è¯•ç”¨å®ç°
    client.py           â† è°ƒç”¨å…¥å£
  demo.py               â† ä¸²è”éªŒè¯
```

**models.py â€” æ•°æ®ç»“æ„ï¼š**

```python
@dataclass
class ChatRequest:
    messages: list[dict[str, str]]   # [{"role": "user", "content": "..."}]
    model: str = "gpt-3.5-turbo"

@dataclass
class ChatResponse:
    content: str
    input_tokens: int      # è¾“å…¥ tokenï¼ˆè®¡è´¹ç”¨ï¼‰
    output_tokens: int     # è¾“å‡º tokenï¼ˆå•ä»·ä¸åŒï¼Œå¿…é¡»åˆ†å¼€è®°ï¼‰
```

**provider.py â€” æŠ½è±¡æ¥å£ï¼š**

```python
class LLMProvider(Protocol):
    def chat(self, request: ChatRequest) -> ChatResponse: ...
```

**client.py â€” è°ƒç”¨å…¥å£ï¼ˆç»„åˆæ¨¡å¼ï¼‰ï¼š**

```python
class LLMClient:
    def __init__(self, provider: LLMProvider):
        self.provider = provider

    def chat(self, request: ChatRequest) -> ChatResponse:
        return self.provider.chat(request)
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```python
client = LLMClient(MockProvider())       # æµ‹è¯•ç¯å¢ƒ
client = LLMClient(DeepSeekProvider())   # ç”Ÿäº§ç¯å¢ƒ
# LLMClient ä»£ç é›¶ä¿®æ”¹
```

------

### Pitfallï¼šçœŸå®è¸©å‘

- **token åªè®°ä¸€ä¸ªæ€»æ•°**ï¼šè¾“å…¥å’Œè¾“å‡ºå•ä»·ä¸åŒï¼ˆGPT-4 è¾“å‡ºå•ä»·æ˜¯è¾“å…¥çš„ 3 å€ï¼‰ï¼Œä¸åˆ†å¼€è®°å°±ç®—ä¸æ¸…æˆæœ¬
- **messages ç±»å‹å†™ list ä¸åŠ æ³›å‹**ï¼šåˆ«äººçœ‹ä¸å‡ºé‡Œé¢æ˜¯ä»€ä¹ˆç»“æ„ï¼Œåç»­ç»´æŠ¤æˆæœ¬é«˜
- **è¿‡æ—©åˆ†ç›®å½•**ï¼š3 ä¸ªæ–‡ä»¶å°±åˆ† models/ å’Œ client/ ä¸¤ä¸ªå­ç›®å½•ï¼Œå¯¼è‡´ import è·¯å¾„å˜æ·±ã€å®¹æ˜“å‡ºé”™ã€‚æ–‡ä»¶å°‘äº 10 ä¸ªæ—¶ä¿æŒæ‰å¹³
- **demo.py ç”¨ç›¸å¯¹å¯¼å…¥**ï¼šé¡¹ç›®æ ¹ç›®å½•çš„è„šæœ¬ä¸åœ¨åŒ…å†…ï¼Œä¸èƒ½ç”¨ `from .xxx`ï¼Œè¦ç”¨åŒ…åç›´æ¥å¯¼å…¥

------

### Applicationï¼šåœ¨ RAG/Agent/æ¶æ„ä¸­çš„ä½ç½®

æœ¬å‘¨ï¼ˆW5ï¼‰å…¨è²Œï¼šD1 æ¥å£è®¾è®¡ï¼ˆä»Šå¤©ï¼Œéª¨æ¶ï¼‰â†’ D2 è¶…æ—¶+é‡è¯• â†’ D3 ç»“æ„åŒ–è¾“å‡º â†’ D4 Mock æµ‹è¯• â†’ D5 README+æˆæœ¬ä¼°ç®—

åç»­å¤ç”¨ï¼šW6 Tools è°ƒç”¨ LLMClient â†’ W8 FastAPI åŒ…è£… LLMClient â†’ M3 RAG æ£€ç´¢ç»“æœæ³¨å…¥ messages â†’ M5 Agent å¤šè½®è°ƒç”¨+å·¥å…·

------

### è§†è§‰é—­ç¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡ä»£ç      â”‚  demo.py / Service / Agent
â”‚  (è°ƒç”¨æ–¹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ä¾èµ–
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLMClient   â”‚  æŒæœ‰ Providerï¼Œè½¬å‘ chat()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç»„åˆï¼ˆä¸æ˜¯ç»§æ‰¿ï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLMProvider  â”‚â—„â”€â”€â”€â”€â”‚ Protocol æ¥å£     â”‚
â”‚ (æŠ½è±¡)       â”‚     â”‚ chat(req) -> res â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å®ç°ï¼ˆé¸­å­ç±»å‹ï¼‰
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚MockProv  â”‚DeepSeek  â”‚OpenAI    â”‚  â† æ–°å¢ä¸æ”¹ Client
  â”‚(æµ‹è¯•)    â”‚Prov      â”‚Prov      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æµï¼š
ChatRequest â”€â”€â†’ Provider.chat() â”€â”€â†’ ChatResponse
(messages,      (å„å®¶APIå®ç°)        (content,
 model)                              input_tokens,
                                     output_tokens)
```

------

### å·¥ç¨‹å¸ˆè®°å¿†åˆ†å±‚

- ğŸ—‘ï¸ **åƒåœ¾åŒºï¼ˆæŸ¥æ–‡æ¡£ï¼‰**ï¼šdataclass è£…é¥°å™¨è¯­æ³•ã€Protocol çš„ import è·¯å¾„ã€PyCharm çš„ Sources Root é…ç½®
- ğŸ” **ç´¢å¼•åŒºï¼ˆè®°å…³é”®è¯ï¼‰**ï¼šmessages ç»“æ„æ˜¯ role + contentã€token åˆ† input/outputã€src å¸ƒå±€åŒ…å†…ç›¸å¯¹å¯¼å…¥ `from .xxx`
- ğŸ’ **æ ¸å¿ƒåŒºï¼ˆå¿…é¡»å†…åŒ–ï¼‰**ï¼šProvider æŠ½è±¡çš„ç›®çš„æ˜¯æ–°å¢å®ç°ä¸æ”¹è°ƒç”¨æ–¹ã€LLMClient ç»„åˆæ¨¡å¼ `__init__` æ¥æ”¶æ¥å£ã€é¸­å­ç±»å‹ä¸éœ€è¦ç»§æ‰¿åªéœ€æ–¹æ³•ç­¾åä¸€è‡´ã€æ–‡ä»¶å°‘æ—¶ä¿æŒæ‰å¹³åˆ«è¿‡æ—©åˆ†ç›®å½•
